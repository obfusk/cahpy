<!doctype html>
<html lang="en">
  <!--

    File        : templates/play.html
    Maintainer  : Felix C. Stegerman <flx@obfusk.net>
    Date        : 2020-03-23

    Copyright   : Copyright (C) 2020  Felix C. Stegerman
    Version     : v0.0.1
    License     : AGPLv3+

  -->
  <head>
    {% include "_meta.html" %}
    <title>cahpy | {{ game }} | {{ name }}</title>
    <style>
      .black {
        color: white;
        background-color: black;
        border: 1px solid white;
      }
      .white {
        color: black;
        background-color: white;
        border: 1px solid black;
      }
      .black, .white {
        display: inline-block;
        padding: 0.2em;
        margin: 1px;
      }
      .top {
        vertical-align: top;
      }
    </style>
  </head>
  <!-- macros -->
  {% macro formstart(id) %}
    <form id="{{ id }}" method="post">
      <input type="hidden" name="game" value="{{ game }}" />
      <input type="hidden" name="name" value="{{ name }}" />
  {% endmacro %}
  {% macro refreshbtn() %}
    <button id="refresh" form="form0">Refresh!</button>
  {% endmacro %}
  {% macro waitingfor(who) %}
    Waiting for {{ who }}...
    <br/>
    <noscript>
      <br/>
      {{ refreshbtn() }}
      <br/>
    </noscript>
  {% endmacro %}
  {% macro blackcard(card) %}
    Black card:
    <span class="black">{{ black[card]|safe }}</span>
    <br/>
  {% endmacro %}
  {% macro whitecards(i, info = "", cls = "radio") %}
    White card{{ info }}:
    <br/>
    <table>
    {% for c in cur["cards"][name] %}
      <tr><td class="top">
      <input type="radio" id="card{{ i }}-{{ c }}"
        name="card{{ i }}" value="{{ c }}" class="{{ cls }}">
      </td><td>
      <label for="card{{ i }}-{{ c }}" class="white">
        {{ white[c]|safe }}
      </label>
      </td></tr>
    {% endfor %}
    </table>
    <br/>
  {% endmacro %}
  {% macro answerlist(answers, radio = True, votes = False) %}
    Answers:
    <br/>
    <table>
    {% for p, a in answers %}
      <tr><td class="top">
      {% if radio %}
        <input type="radio" id="answ{{ loop.index }}"
          name="answ" value="{{ a|join(",") }}"
          {% if name == p %}disabled{% endif %}>
        </td><td>
        <label for="answ{{ loop.index }}">
      {% else %}
        Â»
        </td><td>
      {% endif %}
        {% for c in a %}
          <span class="white">{{ white[c]|safe }}</span>
        {% endfor %}
      {% if radio %}
        </label>
      {% endif %}
      {% if votes %}
        </td><td>
        {% if nietzsche %}
          ({{ votes_for(p) }})
        {% endif %}
        {{ p or "" }}
      {% endif %}
      </td></tr>
    {% endfor %}
    </table>
    <br/>
  {% endmacro %}
  <body>
    <!-- refresh/restart form -->
    {{ formstart("form0") }}
    </form>
    <!-- main form -->
    {{ formstart("form") }}
      <!-- game & player info -->
      Game:
      <a href="/?game={{ game }}">{{ game }}</a>
      <br/>
      Players: {{ players }}
      <br/>
      Your name: {{ name }}
      {% if you_czar %}
        <br/>
        <strong>You're the czar!</strong>
      {% elif nietzsche %}
        <br/>
        <strong>Knights Who Say "Nietzsche!"</strong>
      {% endif %}
      <br/>
      {% if card is not none %}
        <br/>
        {{ blackcard(card) }}
      {% endif %}
      {% if msg %}
        <br/>
        {{ msg }}
        <br/>
      {% endif %}
      <br/>
      <!-- ready for first/new round -->
      {% if card is none %}
        {% set waiting = true %}
        {% if prev is not none %}
          {{ blackcard(prev["card"]) }}
          <br/>
          {{ answerlist(prev["answers"], False, True) }}
        {% endif %}
        <noscript>
          {{ refreshbtn() }}
        </noscript>
        <button name="start" value="start">New round!</button>
        <br/>
      <!-- playing -->
      {% else %}
        {% set answered = name in cur["answers"]  %}
        {% set voted    = name in cur["votes"]    %}
        <!-- czar -->
        {% if you_czar or (nietzsche and answered) %}
          <!-- vote -->
          {% if complete and not (nietzsche and voted) %}
            {{ answerlist(answers) }}
            <button>Choose!</button>
            <br/>
          <!-- waiting for players -->
          {% else %}
            {% set waiting = true %}
            {{ waitingfor("players") }}
          {% endif %}
        <!-- player -->
        {% else %}
          <!-- answered & waiting -->
          {% if answered %}
            {% set waiting = true %}
            {% if complete %}
              {{ answerlist(answers, False) }}
            {% endif %}
            {{ waitingfor("czar") }}
          <!-- answer -->
          {% else %}
            {% set multiple = cur["blanks"] > 1 %}
            {% for i in range(cur["blanks"]) %}
              {{ whitecards(i, " #{}".format(i+1) if multiple else "") }}
            {% endfor %}
            {{ whitecards("d", " to discard (optional)", "") }}
            <script>
              document.getElementById("form").onsubmit = e => {
                const b = {{ cur["blanks"] }}
                const r = document.getElementsByClassName("radio")
                const s = (new Set(Array.from(r).filter(x => x.checked)
                                   .map(x => x.value))).size
                if (s != b) {
                  alert(`Please select ${b} (different) card(s).`)
                  e.preventDefault()
                }
              }
            </script>
            <button>Choose!</button>
            <br/>
          {% endif %}
        {% endif %}
      {% endif %}
      <br/>
      <hr/>
      #black: {{ cur["blk"]|length }},
      #white: {{ cur["wht"]|length }}
      <br/>
      <br/>
      <button name="restart" value="restart" form="form0">Restart!</button>
      <script>
        document.getElementById("form0").onsubmit = e => {
          if (!window.confirm("Discard current game?")) {
            e.preventDefault()
          }
        }
      </script>
      <small>(discards current game)</small>
    </form>
    {% if waiting %}
      <script>
        window.onload = () => {
          const tick = {{ tick }}
          const f = () => {
            const r = new XMLHttpRequest()
            r.addEventListener("load", e => {
              if (r.status != 200) { return }
              const t = JSON.parse(r.responseText).tick
              if (t > tick) {
                document.getElementById("form0").submit()
              } else {
                setTimeout(f, {{ POLL }})
              }
            })
            r.open("GET", "/status/{{ game }}")
            r.send()
          }
          setTimeout(f, {{ POLL }})
        }
      </script>
    {% endif %}
    {% include "_footer.html" %}
  </body>
</html>
